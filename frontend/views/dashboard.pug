extends layout.pug

block content
  #app-container(class="min-h-screen flex")
    include includes/sidebar.pug
    
    main(class="ml-64 flex-1 p-8 bg-slate-50 min-h-screen")
      #page-dashboard.page-content.active
        //- 头部
        header(class="flex justify-between items-center mb-8")
          div
            h2(class="text-3xl font-bold") 服务监控仪表板
            p(class="text-slate-500") 实时查看集群健康度与资源利用率
          div(class="flex gap-4")
            button(class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-slate-50 transition")
              i(class="fas fa-sync-alt")
              | 刷新频率: 15s
            div(class="flex items-center gap-2 bg-blue-50 text-blue-700 px-4 py-2 rounded-lg text-sm font-semibold")
              span(class="status-dot pulse-green")
              | 系统状态良好

        //- 资源卡片 (使用动态数据)
        div(class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8")
          //- 卡片1: 运行中服务
          div(class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100")
            div(class="flex justify-between items-start mb-4")
              div(class="p-3 bg-blue-50 text-blue-600 rounded-xl")
                i(class="fas fa-server")
              span(class="text-xs text-green-500 font-bold font-mono") #{metrics.runningServices.onlineRate}
            h3(class="text-slate-500 text-sm") 运行中服务
            p(class="text-2xl font-bold") #{metrics.runningServices.current} / #{metrics.runningServices.total}
          
          //- 卡片2: 算力负载
          div(class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100")
            div(class="flex justify-between items-start mb-4")
              div(class="p-3 bg-orange-50 text-orange-600 rounded-xl")
                i(class="fas fa-microchip")
              span(class="text-xs text-slate-400 font-mono") #{metrics.computeLoad.type}
            h3(class="text-slate-500 text-sm") 算力负载
            p(class="text-2xl font-bold") #{metrics.computeLoad.percentage}
          
          //- 卡片3: 内存占用
          div(class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100")
            div(class="flex justify-between items-start mb-4")
              div(class="p-3 bg-indigo-50 text-indigo-600 rounded-xl")
                i(class="fas fa-memory")
              span(class="text-xs text-slate-400 font-mono") #{metrics.memoryUsage.used} / #{metrics.memoryUsage.total} GB
            h3(class="text-slate-500 text-sm") 显存/内存占用
            p(class="text-2xl font-bold") #{metrics.memoryUsage.percentage}
          
          //- 卡片4: 任务队列
          div(class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100")
            div(class="flex justify-between items-start mb-4")
              div(class="p-3 bg-teal-50 text-teal-600 rounded-xl")
                i(class="fas fa-tasks")
              span(class="text-xs text-teal-600 font-mono") #{metrics.taskQueue.status}
            h3(class="text-slate-500 text-sm") 解析任务队列
            p(class="text-2xl font-bold") #{metrics.taskQueue.count}

        //- 核心板块：服务管理
        div(class="grid grid-cols-1 lg:grid-cols-3 gap-8")
          //- 服务列表 (左侧主区域)
          div(class="lg:col-span-2 space-y-6")
            div(class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden")
              div(class="p-6 border-b border-slate-100")
                div(class="flex justify-between items-center mb-4")
                  h3(class="font-bold text-lg") 服务运行清单
                  span(class="text-xs text-slate-400" id="service-count") 共 #{services.length} 个服务
                
                //- 过滤器
                div(class="grid grid-cols-3 gap-4")
                  div(class="relative")
                    span(class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400")
                      i(class="fas fa-search text-xs")
                    input(type="text" id="filter-name" placeholder="搜索名称..." class="pl-9 w-full bg-slate-50 border border-slate-200 rounded-lg py-1.5 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none")
                  
                  select(id="filter-type" class="bg-slate-50 border border-slate-200 rounded-lg py-1.5 px-3 text-xs focus:ring-2 focus:ring-blue-500 outline-none")
                    option(value="") 所有类型
                    option(value="Core") Core
                    option(value="Agent") Agent
                    option(value="Container") Container
                  
                  select(id="filter-status" class="bg-slate-50 border border-slate-200 rounded-lg py-1.5 px-3 text-xs focus:ring-2 focus:ring-blue-500 outline-none")
                    option(value="") 所有状态
                    option(value="Running") 运行中
                    option(value="Stopped") 已停止
                    option(value="Offline") 已离线

              div(class="overflow-x-auto max-h-[500px] overflow-y-auto pr-2")
                table(class="w-full" id="services-table")
                  thead(class="bg-slate-50 text-slate-500 text-xs text-left uppercase tracking-wider sticky top-0 z-10")
                    tr
                      th(class="px-6 py-4") 服务名称
                      th(class="px-6 py-4") 角色/类型
                      th(class="px-6 py-4") 健康状况
                      th(class="px-6 py-4") 操作
                  tbody(class="divide-y divide-slate-100 text-sm")
                    //- 1. Core Services (Top level)
                    each service in services.filter(s => s.type === 'Core')
                      tr(data-name=service.name.toLowerCase() data-type=service.type data-status=service.status)
                        td(class="px-6 py-4")
                          div(class="font-semibold text-slate-700")= service.name
                        td(class="px-6 py-4")
                          span(class="bg-purple-50 text-purple-700 px-2 py-1 rounded text-xs")= service.type
                          if service.message
                            div(class="text-[10px] text-slate-400 mt-1 max-w-xs truncate" title=service.message)= service.message
                        td(class="px-6 py-4")
                          span(class="text-green-500 flex items-center gap-2 font-medium")
                            i(class="fas fa-check-circle text-xs")
                            | 运行中
                        td(class="px-6 py-4")
                          // Core services usually don't have operations here

                    //- 2. Grouped Agents & Containers
                    - const nodeIPs = [...new Set(services.filter(s => s.type !== 'Core').map(s => s.node_ip))]
                    each nodeIP in nodeIPs
                      //- Agent row
                      - const agent = services.find(s => s.type === 'Agent' && s.node_ip === nodeIP)
                      if agent
                        tr(class="bg-slate-50/50" data-name=agent.name.toLowerCase() data-type=agent.type data-status=agent.status)
                          td(class="px-6 py-4")
                            div(class="font-bold text-slate-800 flex items-center gap-2")
                              i(class="fas fa-server text-blue-500 text-xs")
                              = agent.name
                            div(class="text-[10px] text-slate-400 font-mono pl-5")= agent.node_ip
                          td(class="px-6 py-4")
                            span(class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs") Host Agent
                            if agent.message
                              div(class="text-[10px] text-slate-400 mt-1 max-w-xs truncate pl-1" title=agent.message)= agent.message
                          td(class="px-6 py-4")
                            if agent.status === 'Running'
                              span(class="text-green-500 flex items-center gap-2 font-medium")
                                i(class="fas fa-check-circle text-xs")
                                | 运行中
                            else
                              span(class="text-red-500 flex items-center gap-2 font-medium")
                                i(class="fas fa-times-circle text-xs")
                                | 已离线
                          td(class="px-6 py-4")
                            button(class="text-slate-400 hover:text-blue-600 mr-3" title="重启 Agent" onclick=`restartService('${agent.name}', '${agent.node_ip}', 'Agent')`)
                              i(class="fas fa-redo")
                            button(class="text-slate-400 hover:text-red-600" title="停止 Agent" onclick=`stopService('${agent.name}', '${agent.node_ip}', 'Agent')`)
                              i(class="fas fa-power-off")

                      //- Nested Containers for this node
                      each container in services.filter(s => s.type === 'Container' && s.node_ip === nodeIP)
                        tr(class="hover:bg-slate-50 transition-colors" data-name=container.name.toLowerCase() data-type=container.type data-status=container.status)
                          td(class="px-6 py-4 pl-12 border-l-2 border-slate-100")
                            div(class="font-semibold text-slate-600 flex items-center gap-2")
                              i(class="fas fa-box text-slate-400 text-[10px]")
                              = container.name
                          td(class="px-6 py-4")
                            span(class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-[10px] uppercase")= container.type
                            if container.message
                              div(class="text-[10px] text-slate-400 mt-1 max-w-xs truncate" title=container.message)= container.message
                          td(class="px-6 py-4")
                            if container.status === 'Running'
                              span(class="text-green-500 flex items-center gap-2 font-medium")
                                i(class="fas fa-check-circle text-xs")
                                | 运行中
                            else if container.status === 'Offline'
                              span(class="text-slate-400 flex items-center gap-2 font-medium")
                                i(class="fas fa-minus-circle text-xs")
                                | 离线 (节点异常)
                            else
                              span(class="text-red-500 flex items-center gap-2 font-medium")
                                i(class="fas fa-stop-circle text-xs")
                                | 已停止
                          td(class="px-6 py-4")
                            button(class="text-slate-400 hover:text-blue-600 mr-3" title="重启容器" onclick=`restartService('${container.name}', '${container.node_ip}', 'Container')`)
                              i(class="fas fa-redo")
                            button(class="text-slate-400 hover:text-red-600" title="停止容器" onclick=`stopService('${container.name}', '${container.node_ip}', 'Container')`)
                              i(class="fas fa-power-off")

            //- 备份模块
            div(class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6")
              h3(class="font-bold text-lg mb-4") 数据备份与灾备恢复
              div(class="grid grid-cols-1 md:grid-cols-2 gap-4")
                div(class="border border-slate-100 rounded-xl p-4 hover:border-blue-200 transition")
                  h4(class="font-bold text-sm mb-2")
                    i(class="fas fa-cloud-upload-alt text-blue-600 mr-2")
                    | 上次备份
                  p(class="text-xs text-slate-500 mb-4") #{backupInfo.lastBackup.time} (#{backupInfo.lastBackup.type})
                  button(class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-blue-700" onclick="startFullBackup()") 立即执行全量备份
                
                div(class="border border-slate-100 rounded-xl p-4 hover:border-orange-200 transition")
                  h4(class="font-bold text-sm mb-2")
                    i(class="fas fa-history text-orange-600 mr-2")
                    | 快速恢复
                  p(class="text-xs text-slate-500 mb-4") 可用备份点: #{backupInfo.availablePoints} 个
                  button(class="w-full bg-white border border-slate-200 text-slate-700 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50" onclick="restoreFromBackup()") 从最近备份点恢复

          //- 参数配置侧栏 (右侧)
          div(class="space-y-6")
            //- 模型推理配置
            div(class="bg-slate-900 rounded-2xl p-6 text-white shadow-xl")
              h3(class="font-bold mb-4 flex items-center gap-2")
                i(class="fas fa-sliders-h text-blue-400")
                | 模型推理配置
              div(class="space-y-4")
                div
                  label(class="text-[10px] uppercase text-slate-400 font-bold block mb-1") Max Concurrency 并发限制
                  input(type="range" class="w-full accent-blue-500 bg-slate-800" min="1" max="256" value=config.concurrency onchange="updateConcurrency(this.value)")
                  div(class="flex justify-between text-[10px] font-mono mt-1 text-slate-500")
                    span 1
                    span #{config.concurrency} (Current)
                    span 256
                
                div
                  label(class="text-[10px] uppercase text-slate-400 font-bold block mb-1") Token Limit 上下文长度
                  select(class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 text-xs focus:ring-2 focus:ring-blue-500" onchange="updateTokenLimit(this.value)")
                    each option in config.tokenOptions
                      option(value=option.value selected=option.selected)= option.label
                
                div(class="pt-4 border-t border-slate-800 space-y-2")
                  div(class="flex justify-between items-center text-xs")
                    span(class="text-slate-400") 动态批处理 (Dynamic Batching)
                    span(class=`px-2 py-0.5 rounded text-[10px] ${config.dynamicBatching ? 'bg-green-900/50 text-green-400' : 'bg-gray-700 text-gray-400'}`)= config.dynamicBatching ? 'ON' : 'OFF'
                  div(class="flex justify-between items-center text-xs")
                    span(class="text-slate-400") 硬件加速类型
                    span(class="text-slate-200")= config.hardwareAcceleration
                
                button(class="w-full mt-4 bg-blue-600 py-3 rounded-xl text-sm font-bold hover:bg-blue-500 transition shadow-lg shadow-blue-500/30" onclick="saveConfigAndRestart()")
                  | 保存配置并重启服务
                p(class="text-[10px] text-center text-slate-500 italic") 注：更改推理参数需重启服务，预计中断 15s

            //- 审计日志简报
            div(class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6")
              h3(class="font-bold text-sm mb-4") 最近操作审计
              div(class="space-y-4")
                //- 动态渲染审计日志
                each log, index in auditLogs
                  if index < 2
                    div(class="flex gap-3 items-start")
                      div(class=`w-8 h-8 rounded-full ${log.type === 'user' ? 'bg-slate-100' : 'bg-green-100'} flex items-center justify-center shrink-0 text-xs ${log.type === 'user' ? 'text-slate-500' : 'text-green-600'}`)
                        i(class=`fas ${log.type === 'user' ? 'fa-user' : 'fa-check'}`)
                      div
                        p(class="text-xs font-bold text-slate-700")
                          | #{log.user} 
                          span(class="font-normal text-slate-500") #{log.action}
                        p(class="text-[10px] text-slate-400") #{log.time} · #{log.details}



block scripts
  script(src="/js/dashboard.js")