extends layout.pug

block styles
  style.
    .step-content { display: none; }
    .step-content.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    /* Hide scrollbar for clean look */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

block content
  #app-container(class="min-h-screen flex")
    include includes/sidebar.pug
    
    main(class="ml-64 flex-1 p-8 bg-slate-50 min-h-screen")
      #page-deployment.page-content.active
        //- Tabs Header
        header(class="mb-8 flex justify-between items-center")
          div
            h2(class="text-2xl font-bold text-slate-800") 机器节点和部署管理
            p(class="text-slate-500 text-sm") 管理 AI 基础设施部署

        //- TAB 1: Deployment Wizard
        #tab-wizard-content
          .bg-white.rounded-2xl.shadow-sm.border.border-slate-100.overflow-hidden.max-w-5xl.mx-auto
            //- Wizard Progress
            .bg-slate-50.p-6.border-b.border-slate-100
              .flex.justify-between.px-8.items-center
                //- Step 1 (Now Basic Config)
                .step-indicator.flex.flex-col.items-center.gap-2.text-blue-600(data-step="1")
                  .w-8.h-8.rounded-full.bg-blue-600.text-white.flex.items-center.justify-center.font-bold.text-sm 1
                  span(class="text-xs font-bold") 基础配置
                .flex-1.h-px.bg-slate-200.mx-4
                //- Step 2 (Now Mode/Hardware)
                .step-indicator.flex.flex-col.items-center.gap-2.text-slate-400(data-step="2")
                  .w-8.h-8.rounded-full.bg-white.border-2.border-slate-200.text-slate-400.flex.items-center.justify-center.font-bold.text-sm 2
                  span(class="text-xs") 模式/硬件
                .flex-1.h-px.bg-slate-200.mx-4
                //- Step 3
                .step-indicator.flex.flex-col.items-center.gap-2.text-slate-400(data-step="3")
                  .w-8.h-8.rounded-full.bg-white.border-2.border-slate-200.text-slate-400.flex.items-center.justify-center.font-bold.text-sm 3
                  span(class="text-xs") 推理引擎
                .flex-1.h-px.bg-slate-200.mx-4
                //- Step 4
                .step-indicator.flex.flex-col.items-center.gap-2.text-slate-400(data-step="4")
                  .w-8.h-8.rounded-full.bg-white.border-2.border-slate-200.text-slate-400.flex.items-center.justify-center.font-bold.text-sm 4
                  span(class="text-xs") 知识库
                .flex-1.h-px.bg-slate-200.mx-4
                //- Step 5
                .step-indicator.flex.flex-col.items-center.gap-2.text-slate-400(data-step="5")
                  .w-8.h-8.rounded-full.bg-white.border-2.border-slate-200.text-slate-400.flex.items-center.justify-center.font-bold.text-sm 5
                  span(class="text-xs") 部署生成

            form#wizard-form.p-8
              //- STEP 1 (Swapped): Management Interface
              #step-1.step-content.active
                h3(class="font-bold text-lg mb-6") 1. 管理面板与节点配置
                .grid.grid-cols-2.gap-6
                  div
                    label.block.text-sm.font-medium.text-slate-700.mb-1 管理面板 Host
                    input(type="text", name="mgmt_host", value="172.20.0.1", class="w-full rounded-lg border-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500")
                  div
                    label.block.text-sm.font-medium.text-slate-700.mb-1 管理面板 Port
                    input(type="number", name="mgmt_port", value="3000", class="w-full rounded-lg border-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500")
                
                //- SSH Configuration Guide
                .mt-6.p-4.bg-blue-50.rounded-xl.border.border-blue-100
                  h4.font-bold.text-sm.text-blue-800.mb-2 
                    i.fas.fa-key.mr-2
                    | Configure Passwordless SSH Access
                  p.text-xs.text-blue-600.mb-3 To manage remote nodes, please use the system-generated SSH key.
                  
                  .flex.items-center.gap-4.mb-4
                    button(type="button", onclick="downloadSSHKey()", class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 shadow-sm")
                      i.fas.fa-download.mr-2
                      | Download System SSH Key
                    span.text-xs.text-blue-400 (id_rsa.pub)

                  .bg-white.p-3.rounded-lg.border.border-blue-200
                    code.text-xs.text-slate-600.block.mb-1 # On each target node, add this key to authorized_keys:
                    code.text-xs.font-mono.text-slate-800.block cat id_rsa.pub >> ~/.ssh/authorized_keys

                //- Target Nodes Configuration
                .mt-6
                  label.block.text-sm.font-medium.text-slate-700.mb-2 目标计算节点 (Target Nodes)
                  textarea(name="target_nodes", rows="3", placeholder="Enter IP addresses and ports, one per line\n192.168.1.101:22\n192.168.1.102:22", class="w-full rounded-lg border-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500 text-sm font-mono")
                  p.text-xs.text-slate-500.mt-1 输入将部署推理服务或向量库的节点 IP 列表。
                
                .mt-3
                  button(type="button", onclick="testConnection('ssh')", class="text-blue-700 text-xs font-bold hover:underline bg-white px-3 py-2 rounded border border-blue-200 shadow-sm") 
                    i.fas.fa-terminal.mr-1
                    | Verify SSH Connectivity (Check Target Nodes)

                p.text-xs.text-slate-500.mt-4.bg-blue-50.p-3.rounded-lg.border.border-blue-100
                  i.fas.fa-info-circle.mr-2
                  | 这是 AnyAdmin 管理界面的访问地址及集群节点配置。

              //- STEP 2 (Swapped): Mode & Hardware
              #step-2.step-content
                h3(class="font-bold text-lg mb-6") 2. 选择部署模式与硬件
                
                label.block.text-sm.font-bold.text-slate-700.mb-2 部署模式
                .grid.grid-cols-2.gap-6.mb-8
                  label.cursor-pointer
                    input(type="radio", name="mode", value="new_deployment", class="peer sr-only", checked)
                    div(class="p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-500 peer-checked:border-blue-600 peer-checked:bg-blue-50 transition h-full")
                      .w-12.h-12.bg-blue-100.text-blue-600.rounded-xl.flex.items-center.justify-center.mb-4.text-xl
                        i(class="fas fa-cube")
                      h4(class="font-bold text-slate-800 mb-2") 全新部署
                      p(class="text-xs text-slate-500 leading-relaxed") 自动拉取并配置所有核心组件。适用于空环境。

                  label.cursor-pointer
                    input(type="radio", name="mode", value="integrate_existing", class="peer sr-only")
                    div(class="p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-500 peer-checked:border-blue-600 peer-checked:bg-blue-50 transition h-full")
                      .w-12.h-12.bg-indigo-100.text-indigo-600.rounded-xl.flex.items-center.justify-center.mb-4.text-xl
                        i(class="fas fa-plug")
                      h4(class="font-bold text-slate-800 mb-2") 对接现有服务
                      p(class="text-xs text-slate-500 leading-relaxed") 手动输入现有服务 IP/Port，仅部署管理面板。

                label.block.text-sm.font-bold.text-slate-700.mb-2 目标硬件平台
                .grid.grid-cols-2.gap-4
                  label.cursor-pointer
                    input(type="radio", name="platform", value="ascend", class="peer sr-only")
                    div(class="flex items-center gap-3 px-6 py-4 border-2 border-slate-200 rounded-xl font-bold text-slate-600 hover:border-blue-500 peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:text-blue-700 transition")
                      i(class="fas fa-microchip")
                      div
                        div 华为昇腾 (Ascend NPU)
                        div.text-xs.font-normal.mt-1 引擎: MindIE
                  
                  label.cursor-pointer
                    input(type="radio", name="platform", value="nvidia", class="peer sr-only")
                    div(class="flex items-center gap-3 px-6 py-4 border-2 border-slate-200 rounded-xl font-bold text-slate-600 hover:border-blue-500 peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:text-blue-700 transition")
                      i(class="fab fa-nvidia")
                      div
                        div NVIDIA GPU
                        div.text-xs.font-normal.mt-1 引擎: vLLM

              //- STEP 3: Inference Engine
              #step-3.step-content
                h3(class="font-bold text-lg mb-6") 3. 推理引擎配置
                .space-y-4
                  div
                    label.block.text-sm.font-medium.text-slate-700.mb-1 部署目标主机 (Target Host)
                    select#inference-host-select(name="inference_host", class="node-selector w-full rounded-lg border-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500")
                      option(value="") Select Target Node

                  
                  .grid.grid-cols-2.gap-6
                    div
                      label.block.text-sm.font-medium.text-slate-700.mb-1 服务端口
                      input#inference-port-input(type="number", name="inference_port", value="8000", class="w-full rounded-lg border-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500")
                    div.hidden
                      //- Hidden input to store model name if needed for form submission compatibility, or just rely on select value
                      input#model-name-input(type="hidden", name="model_name")

                  div
                    label.block.text-sm.font-medium.text-slate-700.mb-1 推理模型 (Model Selection)
                    .flex.gap-2
                        select#model-select(name="model_path", class="w-full rounded-lg border-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500")
                            option(value="", disabled, selected) Select a Model
                        button(type="button", onclick="refreshModels(true)", class="px-3 py-2 bg-slate-100 border border-slate-300 rounded-lg hover:bg-slate-200 text-slate-600")
                            i.fas.fa-sync-alt


                  //- Show test connection only in integration mode
                  .integration-only.hidden.mt-4
                     button(type="button", onclick="testConnection('inference')", class="text-blue-600 text-sm font-bold hover:underline") <i class="fas fa-plug mr-1"></i> 测试连接

              //- STEP 4: Knowledge Base & RAG App
              #step-4.step-content
                h3(class="font-bold text-lg mb-6") 4. 知识库与应用服务

                //- RAG App Section (New)
                .mb-8.border.border-slate-200.rounded-xl.p-4.bg-white
                  .flex.items-center.justify-between.mb-4
                    label.flex.items-center.gap-2.cursor-pointer
                      input#enable-rag(type="checkbox", name="enable_rag", class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500", checked, onchange="toggleSection('rag-config', this.checked)")
                      span.font-bold.text-slate-700 启用 RAG 应用 (AnythingLLM)
                  
                  #rag-config
                    .bg-slate-50.p-4.rounded-lg.border.border-slate-200
                      .flex.items-center.gap-3.mb-4
                          i(class="fas fa-search text-slate-400")
                          div.flex-1
                              div.font-bold.text-sm AnythingLLM Web App
                              div.text-xs.text-slate-500 Enterprise Search Interface

                      .grid.grid-cols-2.gap-4
                          div
                              label.block.text-xs.font-medium.text-slate-500.mb-1 应用 Host
                              select(name="rag_host", class="node-selector w-full text-sm rounded-md border-2 border-slate-300")
                                option(value="") Select Target Node
                          div
                              label.block.text-xs.font-medium.text-slate-500.mb-1 应用 Port
                              input(type="number", name="rag_port", value="3001", class="w-full text-sm rounded-md border-2 border-slate-300")
                      
                      .mt-3
                         button(type="button", onclick="testConnection('rag_app')", class="text-blue-600 text-xs font-bold hover:underline") <i class="fas fa-plug mr-1"></i> 测试连接

                //- Vector DB Section
                .mb-8.border.border-slate-200.rounded-xl.p-4.bg-white
                  .flex.items-center.justify-between.mb-4
                    label.flex.items-center.gap-2.cursor-pointer
                      input#enable-vectordb(type="checkbox", name="enable_vectordb", class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500", onchange="toggleSection('vectordb-config', this.checked)")
                      span.font-bold.text-slate-700 启用向量数据库 (Vector Database)
                    
                  #vectordb-config.hidden
                    .grid.grid-cols-4.gap-4.mb-4
                      label.cursor-pointer
                        input(type="radio", name="vector_db", value="lancedb", class="peer sr-only", checked)
                        div(class="text-center p-3 border rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 hover:bg-slate-50 transition") LanceDB
                      label.cursor-pointer
                        input(type="radio", name="vector_db", value="milvus", class="peer sr-only")
                        div(class="text-center p-3 border rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 hover:bg-slate-50 transition") Milvus
                      label.cursor-pointer
                        input(type="radio", name="vector_db", value="chroma", class="peer sr-only")
                        div(class="text-center p-3 border rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 hover:bg-slate-50 transition") Chroma
                      label.cursor-pointer
                        input(type="radio", name="vector_db", value="pgvector", class="peer sr-only")
                        div(class="text-center p-3 border rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 hover:bg-slate-50 transition") PgVector

                    .p-4.bg-slate-50.rounded-lg.border.border-slate-200
                      .grid.grid-cols-2.gap-4
                        div
                          label.block.text-xs.font-medium.text-slate-500.mb-1 数据库 Host
                          select(name="vectordb_host", class="node-selector w-full text-sm rounded-md border-2 border-slate-300")
                            option(value="") Select Target Node
                        div
                          label.block.text-xs.font-medium.text-slate-500.mb-1 数据库 Port
                          input(type="number", name="vectordb_port", value="19530", class="w-full text-sm rounded-md border-2 border-slate-300")
                      
                      .integration-only.hidden.mt-3
                         button(type="button", onclick="testConnection('vectordb')", class="text-blue-600 text-xs font-bold hover:underline") <i class="fas fa-plug mr-1"></i> 测试连接

                //- Parser Section
                .mb-8.border.border-slate-200.rounded-xl.p-4.bg-white
                  .flex.items-center.justify-between.mb-4
                    label.flex.items-center.gap-2.cursor-pointer
                      input#enable-parser(type="checkbox", name="enable_parser", class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500", onchange="toggleSection('parser-config', this.checked)")
                      span.font-bold.text-slate-700 启用文档解析服务 (Document Parser)

                  #parser-config.hidden
                    .bg-slate-50.p-4.rounded-lg.border.border-slate-200
                      .flex.items-center.gap-3.mb-4
                          i(class="fas fa-file-alt text-slate-400")
                          div.flex-1
                              div.font-bold.text-sm Mineru (PDF/Docx Parser)
                              div.text-xs.text-slate-500 Primary parsing engine

                      .grid.grid-cols-2.gap-4
                          div
                              label.block.text-xs.font-medium.text-slate-500.mb-1 服务 Host
                              select(name="parser_host", class="node-selector w-full text-sm rounded-md border-2 border-slate-300")
                                option(value="") Select Target Node
                          div
                              label.block.text-xs.font-medium.text-slate-500.mb-1 服务 Port
                              input(type="number", name="parser_port", value="8888", class="w-full text-sm rounded-md border-2 border-slate-300")
                      
                      .integration-only.hidden.mt-3
                         button(type="button", onclick="testConnection('parser')", class="text-blue-600 text-xs font-bold hover:underline") <i class="fas fa-plug mr-1"></i> 测试连接

                
              //- STEP 5: Review & Generate
              #step-5.step-content
                h3(class="font-bold text-lg mb-6") 5. 确认并生成
                .bg-slate-50.rounded-xl.p-6.border-1.border-slate-200.mb-6
                  h4.font-bold.text-sm.text-slate-700.mb-4 配置摘要
                  ul.space-y-3.text-sm.text-slate-600#config-summary
                    //- JS will populate this
                    li 加载中...

                .flex.gap-4
                  button(type="button", onclick="generateDeployment()", class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg shadow-green-200 transition")
                    i(class="fas fa-rocket mr-2") 
                    | 启动部署
                  button(type="button", onclick="exportConfiguration()", class="flex-1 bg-white border-2 border-slate-300 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-50 transition")
                    i(class="fas fa-download mr-2") 
                    | 导出配置文件

                //- Results Container (Populated by JS)
                #generation-results.hidden.mt-6.border-t.pt-6

            //- Footer Navigation
            .bg-slate-50.p-6.border-t.border-slate-100.flex.justify-between.items-center
              button#prev-btn(type="button", class="text-slate-500 font-bold text-sm hover:text-slate-700 px-4 py-2 hidden") 
                i(class="fas fa-arrow-left mr-2")
                | 上一步
              
              button#next-btn(type="button", disabled, class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition ml-auto disabled:opacity-50 disabled:cursor-not-allowed")
                | 下一步
                i(class="fas fa-arrow-right ml-2")

block scripts
  script(src="/js/deployment.js")
