extends layout.pug

block content
  #app-container(class="min-h-screen flex")
    include includes/sidebar.pug
    
    main(class="ml-64 flex-1 p-8 bg-slate-50 min-h-screen")
      #page-services.page-content.active
        header(class="flex justify-between items-center mb-8")
          div
            h2(class="text-2xl font-bold text-slate-800") 服务与模型管理
            p(class="text-slate-500 text-sm") 管理注册的节点、服务以及系统全局配置
          div(class="flex gap-3")
            button(class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700", onclick="showModal('addNodeModal')")
              i(class="fas fa-plus mr-2")
              | 注册新节点
            button(class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700", onclick="showModal('connectServiceModal')")
              i(class="fas fa-plus mr-2")
              | 注册新服务

        //- Tabs
        div(class="border-b border-slate-200 mb-6")
          nav(class="-mb-px flex space-x-8")
            button(class="tab-btn active border-b-2 border-blue-600 py-4 px-1 text-sm font-bold text-blue-600 hover:text-blue-800 whitespace-nowrap", data-target="tab-services") 服务矩阵
            button(class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-bold text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap", data-target="tab-nodes") 注册节点 (Agents)
            button(class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-bold text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap", data-target="tab-system") 系统设置

        //- Tab Content: Services
        #tab-services.tab-content
          if config && config.nodes && config.nodes.length
            .space-y-6
              each node in config.nodes
                div(class="bg-white rounded-xl shadow-sm border border-slate-200 p-6")
                  h3(class="text-lg font-bold text-slate-800 mb-4 flex items-center")
                    i(class="fas fa-server mr-2 text-slate-400")
                    | Node: #{node.node_ip}
                  
                  if node.inference_cfgs && node.inference_cfgs.length
                    h4(class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3") Inference Services (vLLM)
                    .grid.grid-cols-1.gap-4.mb-6(class="md:grid-cols-2")
                      each svc in node.inference_cfgs
                        div(class="border border-slate-200 rounded-lg p-4 hover:border-blue-300 transition cursor-pointer bg-slate-50", onclick=`editServiceConfig('${node.node_ip}', '${svc.name}', 'vllm')`)
                          div(class="flex justify-between items-start")
                            div
                              h5(class="font-bold text-slate-700")= svc.name
                              p(class="text-xs text-slate-500") Model: #{svc.model_name}
                            i(class="fas fa-cog text-slate-300 hover:text-blue-500")
                          div(class="mt-3 text-xs font-mono text-slate-500")
                            span(class="bg-white px-2 py-1 rounded border") Port: #{svc.port}
                  
                  if node.rag_app_cfgs && node.rag_app_cfgs.length
                    h4(class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3") RAG Applications (AnythingLLM)
                    .grid.grid-cols-1.gap-4(class="md:grid-cols-2")
                      each app in node.rag_app_cfgs
                        div(class="border border-slate-200 rounded-lg p-4 hover:border-blue-300 transition cursor-pointer bg-slate-50", onclick=`editServiceConfig('${node.node_ip}', '${app.name}', 'rag')`)
                          div(class="flex justify-between items-start")
                            div
                              h5(class="font-bold text-slate-700")= app.name
                              p(class="text-xs text-slate-500") DB: #{app.vector_db || 'N/A'}
                            i(class="fas fa-cog text-slate-300 hover:text-blue-500")
                          div(class="mt-3 text-xs font-mono text-slate-500")
                            span(class="bg-white px-2 py-1 rounded border") Port: #{app.port}

          else
            .text-center.py-12
              p(class="text-slate-500") No nodes registered.

        //- Tab Content: Nodes
        #tab-nodes.tab-content.hidden
          .bg-white.rounded-xl.shadow-sm.border.border-slate-200.overflow-hidden
            table(class="min-w-full divide-y divide-slate-200")
              thead(class="bg-slate-50")
                tr
                  th(class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider") Node IP
                  th(class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider") Hostname
                  th(class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider") Agent Status
                  th(class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider") Actions
              tbody(class="bg-white divide-y divide-slate-200")
                if config && config.nodes
                  each node in config.nodes
                    tr
                      td(class="px-6 py-4 whitespace-nowrap text-sm font-bold text-slate-700")= node.node_ip
                      td(class="px-6 py-4 whitespace-nowrap text-sm text-slate-500")= node.hostname
                      td(class="px-6 py-4 whitespace-nowrap")
                        span(class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800") Active
                      td(class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium")
                        button(class="text-blue-600 hover:text-blue-900", onclick=`editAgentConfig('${node.node_ip}')`) Configure Agent

        //- Tab Content: System
        #tab-system.tab-content.hidden
          .max-w-2xl.bg-white.rounded-xl.shadow-sm.border.border-slate-200.p-8
            h3(class="text-lg font-bold text-slate-800 mb-6") Platform Configuration
            form#systemForm
              .grid.grid-cols-1.gap-6
                div
                  label(class="block text-sm font-bold text-slate-700 mb-2") Management Backend Host
                  input(type="text", name="mgmt_host", value=config.mgmt_host, class="w-full border rounded-lg p-2.5 text-sm focus:ring-blue-500 focus:border-blue-500")
                  p(class="mt-1 text-xs text-slate-400") IP address where this backend is running.
                
                div
                  label(class="block text-sm font-bold text-slate-700 mb-2") Management Backend Port
                  input(type="text", name="mgmt_port", value=config.mgmt_port, class="w-full border rounded-lg p-2.5 text-sm focus:ring-blue-500 focus:border-blue-500")
                
                div
                  label(class="block text-sm font-bold text-slate-700 mb-2") System Email
                  input(type="email", name="system_email", value="admin@example.com", class="w-full border rounded-lg p-2.5 text-sm focus:ring-blue-500 focus:border-blue-500")
                  p(class="mt-1 text-xs text-slate-400") For alerts and notifications (Not yet implemented).

              .mt-8.pt-6.border-t.flex.justify-end
                button(type="submit", class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700") Save Changes

  //- Modals

  //- Agent Config Modal
  #agentConfigModal.modal
    .bg-white.rounded-xl.shadow-xl.max-w-lg.w-full.p-6
      .flex.justify-between.items-center.mb-6
        h3(class="text-lg font-bold text-slate-800") Edit Reference Agent Config
        button(onclick="hideModal('agentConfigModal')", class="text-slate-400 hover:text-slate-600")
          i(class="fas fa-times")
      
      form#agentConfigForm
        input(type="hidden", name="node_ip_hidden", id="agent_node_ip_hidden")
        .space-y-4
          div
            label(class="block text-xs font-bold text-slate-700 mb-1") Management Host
            input(type="text", name="mgmt_host", class="w-full border rounded p-2 text-sm")
          div
            label(class="block text-xs font-bold text-slate-700 mb-1") Management Port
            input(type="text", name="mgmt_port", class="w-full border rounded p-2 text-sm")
          div
            label(class="block text-xs font-bold text-slate-700 mb-1") Log File Path
            input(type="text", name="log_file", class="w-full border rounded p-2 text-sm")
        
        .mt-6.flex.justify-end.gap-3
          button(type="button", onclick="hideModal('agentConfigModal')", class="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-100 rounded-lg") Cancel
          button(type="submit", class="px-4 py-2 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg") Save

  //- vLLM Config Modal
  #vllmConfigModal.modal
    .bg-white.rounded-xl.shadow-xl.max-w-2xl.w-full.p-6
      .flex.justify-between.items-center.mb-6
        h3(class="text-lg font-bold text-slate-800") Edit vLLM Configuration
        button(onclick="hideModal('vllmConfigModal')", class="text-slate-400 hover:text-slate-600")
          i(class="fas fa-times")
      
      form#vllmConfigForm
        input(type="hidden", name="node_ip")
        input(type="hidden", name="name")
        .space-y-6
          div
            label(class="block text-sm font-bold text-slate-700 mb-2") Optimization Mode 优化模式
            select(class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none", name="optimization_mode", id="vllm-optimization-mode")
              option(value="balanced") Balanced (平衡模式)
              option(value="max_token") Max Token (长文本优先)
              option(value="max_concurrency") Max Concurrency (高并发优先)
            p(class="text-xs text-slate-500 mt-1") * 自动调整并发数和显存分配策略

          div(class="grid grid-cols-2 gap-4")
            div
              label(class="block text-xs font-bold text-slate-700 mb-1") Model Name
              input(type="text", name="model_name", class="w-full border rounded p-2 text-sm bg-slate-50", readonly)
            div
              label(class="block text-xs font-bold text-slate-700 mb-1") Max Model Len
              input(type="number", name="max_model_len", class="w-full border rounded p-2 text-sm")
            div
              label(class="block text-xs font-bold text-slate-700 mb-1") Max Num Seqs
              input(type="number", name="max_num_seqs", class="w-full border rounded p-2 text-sm")
            div
              label(class="block text-xs font-bold text-slate-700 mb-1") Max Batched Tokens
              input(type="number", name="max_num_batched_tokens", class="w-full border rounded p-2 text-sm")
            div
              label(class="block text-xs font-bold text-slate-700 mb-1") GPU Util (0-1)
              input(type="number", name="gpu_memory_utilization", step="0.01", class="w-full border rounded p-2 text-sm")

        .mt-6.flex.justify-end.gap-3
          button(type="button", onclick="hideModal('vllmConfigModal')", class="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-100 rounded-lg") Cancel
          button(type="submit", class="px-4 py-2 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg") Save & Restart

  //- AnythingLLM Config Modal
  #ragConfigModal.modal
    .bg-white.rounded-xl.shadow-xl.max-w-2xl.w-full.p-6.my-8
      .flex.justify-between.items-center.mb-6
        h3(class="text-lg font-bold text-slate-800") Edit AnythingLLM Configuration
        button(onclick="hideModal('ragConfigModal')", class="text-slate-400 hover:text-slate-600")
          i(class="fas fa-times")
      
      form#ragConfigForm
        input(type="hidden", name="host")
        input(type="hidden", name="name")
        .space-y-4
          div
            label(class="block text-xs font-bold text-slate-700 mb-1") Storage Directory
            input(type="text", name="storage_dir", class="w-full border rounded p-2 text-sm")
          
          .grid.grid-cols-2.gap-4
            div
              label(class="block text-xs font-bold text-slate-700 mb-1") LLM Provider
              input(type="text", name="llm_provider", class="w-full border rounded p-2 text-sm")
            div
              label(class="block text-xs font-bold text-slate-700 mb-1") Vector DB
              input(type="text", name="vector_db", class="w-full border rounded p-2 text-sm")
          
          div
            label(class="block text-xs font-bold text-slate-700 mb-1") OpenAI Base Path
            input(type="text", name="generic_openai_base_path", class="w-full border rounded p-2 text-sm")
          
          .grid.grid-cols-2.gap-4
            div
              label(class="block text-xs font-bold text-slate-700 mb-1") Model Pref
              input(type="text", name="generic_openai_model_pref", class="w-full border rounded p-2 text-sm")
            div
              label(class="block text-xs font-bold text-slate-700 mb-1") API Key
              input(type="password", name="generic_openai_api_key", class="w-full border rounded p-2 text-sm")
          
          .grid.grid-cols-2.gap-4
            div
              label(class="block text-xs font-bold text-slate-700 mb-1") Token Limit
              input(type="number", name="generic_openai_model_token_limit", class="w-full border rounded p-2 text-sm")
            div
              label(class="block text-xs font-bold text-slate-700 mb-1") Max Tokens
              input(type="number", name="generic_openai_max_tokens", class="w-full border rounded p-2 text-sm")

        .mt-6.flex.justify-end.gap-3
          button(type="button", onclick="hideModal('ragConfigModal')", class="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-100 rounded-lg") Cancel
          button(type="submit", class="px-4 py-2 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg") Save & Restart

  include includes/modals/service-connect.pug
  include includes/modals/add-node.pug

  //- Inject Config Data
  script.
    window.SERVER_CONFIG_DATA = !{JSON.stringify(config)};

  script(src="/js/services.js")