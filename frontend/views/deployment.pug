extends layout.pug

block styles
  style.
    .step-content { display: none; }
    .step-content.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    /* Hide scrollbar for clean look */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

block content
  #app-container(class="min-h-screen flex")
    include includes/sidebar.pug
    
    main(class="ml-64 flex-1 p-8 bg-slate-50 min-h-screen")
      #page-deployment.page-content.active
        //- Tabs Header
        header(class="mb-6 flex justify-between items-center")
          div
            h2(class="text-2xl font-bold text-slate-800") 机器节点和部署管理
            p(class="text-slate-500 text-sm") 管理 AI 基础设施部署

        //- Tabs Navigation
        nav#deployment-tabs(class="flex gap-8 mb-8 border-b border-slate-200")
          button(data-target="tab-wizard-content", class="tab-btn pb-4 font-bold text-sm border-b-2 border-blue-600 text-blue-600 transition-all") 
            i.fas.fa-magic.mr-2
            | 部署向导
          button(data-target="tab-nodes-content", class="tab-btn pb-4 font-bold text-sm border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-all") 
            i.fas.fa-server.mr-2
            | 节点状态

        //- TAB 1: Deployment Wizard
        #tab-wizard-content.tab-pane
          .bg-white.rounded-2xl.shadow-sm.border.border-slate-100.overflow-hidden.max-w-5xl.mx-auto
            //- Wizard Progress
            .bg-slate-50.p-6.border-b.border-slate-100
              .flex.justify-between.px-8.items-center
                //- Step 1: Basic Config
                .step-indicator.flex.flex-col.items-center.gap-2.text-blue-600(data-step="1")
                  .w-8.h-8.rounded-full.bg-blue-600.text-white.flex.items-center.justify-center.font-bold.text-sm 1
                  span(class="text-xs font-bold") 基础配置
                .flex-1.h-px.bg-slate-200.mx-4
                //- Step 2: Mode, Hardware & Engine
                .step-indicator.flex.flex-col.items-center.gap-2.text-slate-400(data-step="2")
                  .w-8.h-8.rounded-full.bg-white.border-2.border-slate-200.text-slate-400.flex.items-center.justify-center.font-bold.text-sm 2
                  span(class="text-xs") 引擎配置
                .flex-1.h-px.bg-slate-200.mx-4
                //- Step 3: Knowledge Base
                .step-indicator.flex.flex-col.items-center.gap-2.text-slate-400(data-step="3")
                  .w-8.h-8.rounded-full.bg-white.border-2.border-slate-200.text-slate-400.flex.items-center.justify-center.font-bold.text-sm 3
                  span(class="text-xs") 知识库
                .flex-1.h-px.bg-slate-200.mx-4
                //- Step 4: Generation
                .step-indicator.flex.flex-col.items-center.gap-2.text-slate-400(data-step="4")
                  .w-8.h-8.rounded-full.bg-white.border-2.border-slate-200.text-slate-400.flex.items-center.justify-center.font-bold.text-sm 4
                  span(class="text-xs") 部署生成

            form#wizard-form.p-8
              //- STEP 1: Management Interface
              #step-1.step-content.active
                h3(class="font-bold text-lg mb-6") 1. 管理面板与节点配置
                .grid.grid-cols-2.gap-6
                  div
                    label.block.text-sm.font-medium.text-slate-700.mb-1 管理面板 Host
                    input(type="text", name="mgmt_host", value="172.20.0.1", class="w-full rounded-lg border-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500")
                  div
                    label.block.text-sm.font-medium.text-slate-700.mb-1 管理面板 Port
                    input(type="number", name="mgmt_port", value="8080", class="w-full rounded-lg border-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500")
                
                //- SSH Configuration Guide
                .mt-6.p-4.bg-blue-50.rounded-xl.border.border-blue-100
                  h4.font-bold.text-sm.text-blue-800.mb-2 
                    i.fas.fa-key.mr-2
                    | Configure Passwordless SSH Access
                  p.text-xs.text-blue-600.mb-3 To manage remote nodes, please use the system-generated SSH key.
                  
                  .flex.items-center.gap-4.mb-4
                    button(type="button", onclick="downloadSSHKey()", class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 shadow-sm")
                      i.fas.fa-download.mr-2
                      | Download System SSH Key
                    span.text-xs.text-blue-400 (id_rsa.pub)

                  .bg-white.p-3.rounded-lg.border.border-blue-200
                    code.text-xs.text-slate-600.block.mb-1 # On each target node, add this key to authorized_keys:
                    code.text-xs.font-mono.text-slate-800.block cat id_rsa.pub >> ~/.ssh/authorized_keys

                //- Target Nodes Configuration
                .mt-6
                  label.block.text-sm.font-medium.text-slate-700.mb-2 目标计算节点 (Target Nodes)
                  textarea(name="target_nodes", rows="3", placeholder="Enter IP addresses and ports, one per line\n192.168.1.101:22\n192.168.1.102:22", class="w-full rounded-lg border-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500 text-sm font-mono")
                  p.text-xs.text-slate-500.mt-1 输入将部署推理服务或向量库的节点 IP 列表。
                
                .mt-3
                  button(type="button", onclick="testConnection('ssh')", class="text-blue-700 text-xs font-bold hover:underline bg-white px-3 py-2 rounded border border-blue-200 shadow-sm") 
                    i.fas.fa-terminal.mr-1
                    | Verify SSH Connectivity (Check Target Nodes)

                p.text-xs.text-slate-500.mt-4.bg-blue-50.p-3.rounded-lg.border.border-blue-100
                  i.fas.fa-info-circle.mr-2
                  | 这是 AnyAdmin 管理界面的访问地址及集群节点配置。

              //- STEP 2: Mode, Hardware & Engine
              #step-2.step-content
                h3(class="font-bold text-lg mb-6") 2. 推理引擎配置 (模式与硬件)
                
                .grid.grid-cols-2.gap-8.mb-8
                  div
                    label.block.text-sm.font-bold.text-slate-700.mb-3 部署模式
                    .space-y-4
                      label.cursor-pointer.block
                        input(type="radio", name="mode", value="new_deployment", class="peer sr-only", checked)
                        div(class="p-4 rounded-xl border-2 border-slate-200 hover:border-blue-500 peer-checked:border-blue-600 peer-checked:bg-blue-50 transition")
                          .flex.items-center.gap-3
                            .w-10.h-10.bg-blue-100.text-blue-600.rounded-lg.flex.items-center.justify-center.text-lg
                              i(class="fas fa-cube")
                            div
                              h4(class="font-bold text-slate-800 text-sm") 全新部署
                              p(class="text-[10px] text-slate-500") 自动拉起推理服务。
                      
                      label.cursor-pointer.block
                        input(type="radio", name="mode", value="integrate_existing", class="peer sr-only")
                        div(class="p-4 rounded-xl border-2 border-slate-200 hover:border-blue-500 peer-checked:border-blue-600 peer-checked:bg-blue-50 transition")
                          .flex.items-center.gap-3
                            .w-10.h-10.bg-indigo-100.text-indigo-600.rounded-lg.flex.items-center.justify-center.text-lg
                              i(class="fas fa-plug")
                            div
                              h4(class="font-bold text-slate-800 text-sm") 对接现有服务
                              p(class="text-[10px] text-slate-500") 直接接入现有推理引擎。

                  div
                    label.block.text-sm.font-bold.text-slate-700.mb-3 目标硬件平台
                    .space-y-4
                      label.cursor-pointer.block
                        input(type="radio", name="platform", value="nvidia", class="peer sr-only", checked)
                        div(class="p-4 rounded-xl border-2 border-slate-200 hover:border-blue-500 peer-checked:border-blue-600 peer-checked:bg-blue-50 transition")
                          .flex.items-center.gap-3
                            .w-10.h-10.bg-emerald-100.text-emerald-600.rounded-lg.flex.items-center.justify-center.text-lg
                              i(class="fab fa-nvidia")
                            div
                              h4(class="font-bold text-slate-800 text-sm") NVIDIA GPU
                              p(class="text-[10px] text-slate-500") 引擎: vLLM

                      label.cursor-pointer.block
                        input(type="radio", name="platform", value="ascend", class="peer sr-only")
                        div(class="p-4 rounded-xl border-2 border-slate-200 hover:border-blue-500 peer-checked:border-blue-600 peer-checked:bg-blue-50 transition")
                          .flex.items-center.gap-3
                            .w-10.h-10.bg-red-100.text-red-600.rounded-lg.flex.items-center.justify-center.text-lg
                              i(class="fas fa-microchip")
                            div
                              h4(class="font-bold text-slate-800 text-sm") 华为昇腾 (NPU)
                              p(class="text-[10px] text-slate-500") 引擎: MindIE

                .space-y-4.bg-slate-50.p-6.rounded-2xl.border.border-slate-200
                  div
                    label.block.text-sm.font-medium.text-slate-700.mb-1 推理目标主机 (Target Host)
                    select#inference-host-select(name="inference_host", class="node-selector w-full rounded-lg border-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500")
                      option(value="") Select Target Node

                  .grid.grid-cols-2.gap-6
                    div
                      label.block.text-sm.font-medium.text-slate-700.mb-1 服务端口
                      input#inference-port-input(type="number", name="inference_port", value="8000", class="w-full rounded-lg border-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500")
                    div
                      label.block.text-sm.font-medium.text-slate-700.mb-1 推理模型
                      .flex.gap-2
                        select#model-select(name="model_path", class="w-full rounded-lg border-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500")
                          option(value="", disabled, selected) Select a Model
                        button(type="button", onclick="refreshModels(true)", class="px-3 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 text-slate-600 shadow-sm")
                          i.fas.fa-sync-alt

                  .integration-only.hidden.pt-2
                    button(type="button", onclick="testConnection('inference')", class="text-blue-600 text-xs font-bold hover:underline") 
                      i.fas.fa-plug.mr-1
                      | 测试引擎连接

              //- STEP 3: Knowledge Base & RAG App (Always New Deployment)
              #step-3.step-content
                h3(class="font-bold text-lg mb-6") 3. 知识库与应用服务 (自动部署)
                p(class="text-xs text-slate-500 mb-6 -mt-4") 选中的服务将作为全新容器自动部署到指定节点。

                //- RAG App Section
                .mb-6.border.border-slate-200.rounded-xl.p-4.bg-white
                  .flex.items-center.justify-between.mb-4
                    label.flex.items-center.gap-2.cursor-pointer
                      input#enable-rag(type="checkbox", name="enable_rag", class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500", checked, onchange="toggleSection('rag-config', this.checked)")
                      span.font-bold.text-slate-700 启用 RAG 应用 (AnythingLLM)
                  
                  #rag-config
                    .bg-slate-50.p-4.rounded-lg.border.border-slate-200
                      .grid.grid-cols-2.gap-4
                          div
                              label.block.text-xs.font-medium.text-slate-500.mb-1 应用 Host
                              select(name="rag_host", class="node-selector w-full text-sm rounded-md border-2 border-slate-300")
                                option(value="") Select Target Node
                          div
                              label.block.text-xs.font-medium.text-slate-500.mb-1 应用 Port
                              input(type="number", name="rag_port", value="3001", class="w-full text-sm rounded-md border-2 border-slate-300")

                //- Vector DB Section
                .mb-6.border.border-slate-200.rounded-xl.p-4.bg-white
                  .flex.items-center.justify-between.mb-4
                    label.flex.items-center.gap-2.cursor-pointer
                      input#enable-vectordb(type="checkbox", name="enable_vectordb", class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500", onchange="toggleSection('vectordb-config', this.checked)")
                      span.font-bold.text-slate-700 启用向量数据库 (Vector Database)
                    
                  #vectordb-config.hidden
                    .grid.grid-cols-4.gap-4.mb-4
                      label.cursor-pointer
                        input(type="radio", name="vector_db", value="lancedb", class="peer sr-only", checked)
                        div(class="text-center p-2 text-xs border rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 hover:bg-slate-50 transition") LanceDB
                      label.cursor-pointer
                        input(type="radio", name="vector_db", value="milvus", class="peer sr-only")
                        div(class="text-center p-2 text-xs border rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 hover:bg-slate-50 transition") Milvus
                      label.cursor-pointer
                        input(type="radio", name="vector_db", value="chroma", class="peer sr-only")
                        div(class="text-center p-2 text-xs border rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 hover:bg-slate-50 transition") Chroma
                      label.cursor-pointer
                        input(type="radio", name="vector_db", value="pgvector", class="peer sr-only")
                        div(class="text-center p-2 text-xs border rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 hover:bg-slate-50 transition") PgVector

                    .p-4.bg-slate-50.rounded-lg.border.border-slate-200
                      .grid.grid-cols-2.gap-4
                        div
                          label.block.text-xs.font-medium.text-slate-500.mb-1 数据库 Host
                          select(name="vectordb_host", class="node-selector w-full text-sm rounded-md border-2 border-slate-300")
                            option(value="") Select Target Node
                        div
                          label.block.text-xs.font-medium.text-slate-500.mb-1 数据库 Port
                          input(type="number", name="vectordb_port", value="19530", class="w-full text-sm rounded-md border-2 border-slate-300")

                //- Parser Section
                .mb-6.border.border-slate-200.rounded-xl.p-4.bg-white
                  .flex.items-center.justify-between.mb-4
                    label.flex.items-center.gap-2.cursor-pointer
                      input#enable-parser(type="checkbox", name="enable_parser", class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500", onchange="toggleSection('parser-config', this.checked)")
                      span.font-bold.text-slate-700 启用文档解析服务 (Mineru)

                  #parser-config.hidden
                    .bg-slate-50.p-4.rounded-lg.border.border-slate-200
                      .grid.grid-cols-2.gap-4
                          div
                              label.block.text-xs.font-medium.text-slate-500.mb-1 服务 Host
                              select(name="parser_host", class="node-selector w-full text-sm rounded-md border-2 border-slate-300")
                                option(value="") Select Target Node
                          div
                              label.block.text-xs.font-medium.text-slate-500.mb-1 服务 Port
                              input(type="number", name="parser_port", value="8888", class="w-full text-sm rounded-md border-2 border-slate-300")

              //- STEP 4: Review & Generate
              #step-4.step-content
                h3(class="font-bold text-lg mb-6") 4. 确认并生成
                .bg-slate-50.rounded-xl.p-6.border-1.border-slate-200.mb-6
                  h4.font-bold.text-sm.text-slate-700.mb-4 配置摘要
                  ul.space-y-3.text-sm.text-slate-600#config-summary
                    //- JS will populate this
                    li 加载中...

                .flex.gap-4
                  button(type="button", onclick="generateDeployment()", class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg shadow-green-200 transition")
                    i(class="fas fa-rocket mr-2") 
                    | 启动部署
                  button(type="button", onclick="exportConfiguration()", class="flex-1 bg-white border-2 border-slate-300 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-50 transition")
                    i(class="fas fa-download mr-2") 
                    | 导出配置文件

                //- Results Container (Populated by JS)
                #generation-results.hidden.mt-6.border-t.pt-6

            //- Footer Navigation
            .bg-slate-50.p-6.border-t.border-slate-100.flex.justify-between.items-center
              button#prev-btn(type="button", class="text-slate-500 font-bold text-sm hover:text-slate-700 px-4 py-2 hidden") 
                i(class="fas fa-arrow-left mr-2")
                | 上一步
              
              button#next-btn(type="button", disabled, class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition ml-auto disabled:opacity-50 disabled:cursor-not-allowed")
                | 下一步
                i(class="fas fa-arrow-right ml-2")

        //- TAB 2: Nodes Status
        #tab-nodes-content.tab-pane.hidden
          .mb-6.flex.justify-between.items-center
            div
              h3(class="text-lg font-bold text-slate-700") 节点运行状态
              p(class="text-xs text-slate-500") 实时监控节点资源及 Docker 引擎状态
            button(onclick="refreshNodesDashboard()", class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition shadow-sm")
              i.fas.fa-sync-alt.mr-2
              | 刷新列表

          .grid.grid-cols-1.gap-6#nodes-grid
            //- Will be populated by JS
            .bg-white.p-12.rounded-2xl.shadow-sm.border.border-slate-100.text-center
              i.fas.fa-spinner.fa-spin.text-3xl.text-blue-50.mb-4
              p.text-slate-500 加载节点状态中...

    //- Templates for JS injection
    template#node-card-template
      .node-card.bg-white.rounded-2xl.shadow-sm.border.border-slate-100.overflow-hidden
        div(class="node-header p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50")
          .flex.items-center.gap-3
            .w-10.h-10.rounded-xl.bg-blue-600.text-white.flex.items-center.justify-center
              i.fas.fa-server
            .node-info
              h4.node-ip.font-bold.text-slate-800
              span(class="node-port text-xs text-slate-400 font-mono")
          .flex.items-center.gap-3
            div(class="status-badge px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-400 uppercase") Checking...
            .flex.gap-1
              button(type="button" class="agent-start-btn w-8 h-8 rounded-lg bg-white border border-slate-200 text-green-600 hover:bg-green-50 transition flex items-center justify-center" title="Start Agent")
                i.fas.fa-play.text-xs
              button(type="button" class="agent-stop-btn w-8 h-8 rounded-lg bg-white border border-slate-200 text-yellow-600 hover:bg-yellow-50 transition flex items-center justify-center" title="Stop Agent")
                i.fas.fa-stop.text-xs
        div(class="node-details p-6 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4")
          .col-span-full.py-12.text-center
            i.fas.fa-circle-notch.fa-spin.text-blue-500.mb-2
            p.text-xs.text-slate-400 Loading node metrics...
        .node-services.px-6.pb-6
        .node-footer.px-6.pb-6.border-t.border-slate-50.hidden

    template#service-item-template
      .service-item.flex.items-center.gap-3.p-3.border.border-slate-100.rounded-lg
        .w-8.h-8.rounded.bg-slate-50.flex.items-center.justify-center.text-slate-400
          i.fas.fa-box
        .flex-1.overflow-hidden
          .svc-name.text-xs.font-bold.text-slate-700.truncate
          div(class="svc-uptime text-xs text-slate-400 truncate")
        button(class="svc-restart-btn w-6 h-6 rounded hover:bg-slate-100 text-slate-400 hover:text-blue-600 mr-1", title="Restart Service")
            i.fas.fa-redo.text-xs
        button(class="svc-stop-btn w-6 h-6 rounded hover:bg-slate-100 text-slate-400 hover:text-red-600 mr-1", title="Stop Service")
            i.fas.fa-power-off.text-xs
        button(class="svc-config-btn hidden w-6 h-6 rounded hover:bg-slate-100 text-slate-400 hover:text-blue-600", title="Configure")
            i.fas.fa-cog.text-xs
        .svc-status-dot.w-2.h-2.rounded-full

    template#verification-area-template
      .mt-6.pt-6.border-t.border-slate-200.text-center
        h4.text-sm.font-bold.text-slate-700.mb-2 部署进度验证
        p.text-xs.text-slate-500.mb-4 正在等待节点 Agent 建立连接并上报心跳。成功后将自动跳转至仪表板。
        
        #agent-status-container.mb-4.p-4.bg-blue-50.border.border-blue-100.rounded-lg.max-w-md.mx-auto
          .flex.items-center.justify-center.gap-3
            i.fas.fa-satellite-dish.fa-spin.text-blue-600
            span#agent-status-text.text-sm.font-bold.text-blue-800 安装需时，请耐心等待 Agent 心跳...
          p#agent-target-ip.text-xs.text-blue-600.mt-1 目标地址: ...
          
          #agent-stats.hidden.mt-3.grid.grid-cols-2.gap-2.border-t.border-blue-100.pt-2
            .text-center
              div(class="text-xs text-blue-400 uppercase") CPU 使用率
              #agent-cpu.text-sm.font-bold.text-blue-700 - %
            .text-center
              div(class="text-xs text-blue-400 uppercase") 内存使用率
              #agent-mem.text-sm.font-bold.text-blue-700 - %

        #services-status-container.hidden.mt-6.text-left.max-w-2xl.mx-auto
          .flex.items-center.justify-between.mb-3
            h5.text-xs.font-bold.text-slate-50.uppercase.tracking-wider 运行中的服务 (Agent 已检测)
            div(id="docker-badge" class="px-2 py-0.5 rounded text-xs font-bold")
          #services-list.grid.grid-cols-1.gap-2
            p.text-xs.text-slate-400.italic 检测服务中...

    template#metric-card-template
      .p-4.bg-slate-50.rounded-xl.border.border-slate-100
        .flex.justify-between.items-center.mb-1
          div(class="metric-label text-xs text-slate-400 font-bold uppercase")
          div(class="metric-capacity text-xs text-slate-400 font-mono")
        .metric-value.text-xl.font-bold.text-slate-800
        .w-full.bg-slate-200.h-1.rounded-full.mt-2
          .metric-progress.h-1.rounded-full

    template#docker-card-template
      .p-4.bg-slate-50.rounded-xl.border.border-slate-100
        .flex.justify-between.items-center.mb-1
          div(class="text-xs text-slate-400 font-bold uppercase") Docker Engine
          button(class="docker-fix-btn text-xs text-blue-600 hover:underline font-bold hidden")
            i.fas.fa-wrench.mr-1
            | FIX
        .docker-status.text-sm.font-bold
        div(class="flex items-center gap-1 mt-1.5 text-slate-400")
          i(class="fas fa-box text-xs")
          span(class="text-xs font-medium uppercase") Container Runtime

block scripts
  script(src="/js/deployment.js")
